---
layout:     post
title:      "CORS on Kubernetes Ingress Nginx"
subtitle:   "Painless CORS header configuration in Kubernetes"
date:       2018-05-28
author:     "Craig Johnston"
URL:        "kubernetes-ingress-nginx-cors/"
image:      "/img/post/bwire.jpg"
twitter_image: "/img/post/bwire_876_438.jpg"
tags:
- Kubernetes
- Security
- Ingress
series:
- Kubernetes
---

Using [ingress]-nginx on [Kubernetes] makes adding [CORS] headers painless. Kubernetes [ingress]-nginx uses [annotations] as a quick way to allow you to specify the automatic generation of an extensive list of common [nginx] configuration options.

Example [ingress] configuration enabling [CORS]:

```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: api
  namespace: fuse
  labels:
    app: api
  annotations:
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "PUT, GET, POST, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://admin.example.com"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - backend:
          serviceName: api-example
          servicePort: 80
        path: /api
  tls:
  - hosts:
    - api.example.com
    secretName: example-tls
```

You can check the nginx configuration file generated by Kubernetes [ingress]-nginx on any of the ingress controller pods.

If you set up the standard Kubernetes [ingress]-nginx on your cluster, you should have one or more controller pods running in the ingress-nginx namespace.

```bash
kubectl get pods -n ingress-nginx

NAME                                      READY     STATUS    RESTARTS   AGE
default-http-backend-5c6d95c48-xvs55      1/1       Running   0          26d
nginx-ingress-controller-f5676dc7-5ks6q   1/1       Running   0          26d
nginx-ingress-controller-f5676dc7-cjl6l   1/1       Running   0          26d
nginx-ingress-controller-f5676dc7-kthxn   1/1       Running   0          26d
nginx-ingress-controller-f5676dc7-rvhbv   1/1       Running   0          26d
```

Pick a controller and `cat` the nginx configuration:

```bash
# pipe the config to less or your favorite text reader
kubectl exec -n ingress-nginx \
    nginx-ingress-controller-f5676dc7-kthxn \
    cat /etc/nginx/nginx.conf | less
```

You can see that [ingress]-nginx created some header directives for nginx:

```plain
...
more_set_headers 'Access-Control-Allow-Credentials: true';
...
```

### About [CORS]

[CORS], or [Cross-origin resource sharing][CORS] consists of a few HTTP response headers intended to let a web browser know if it's ok to POST data to a specific endpoint. Before a web browser lets Javascript issue a POST to a URL, then performs a "preflight" request. A preflight request is merely a request to the server with the same URL using the method OPTIONS rather than POST. The web browser checks the HTTP headers for [CORS] related headers to determine if POSTing data on behalf of the user is ok.

{{< content-ad >}}

## Port Forwarding / Local Development

Check out [kubefwd](https://github.com/txn2/kubefwd) for a simple command line utility that bulk forwards services of one or more namespaces to your local workstation.

## Resources

If you found this article useful, you may want to check out [all my articles on Kubernetes][phc.txn2.net], used to build on the [Production Hobby Cluster]. [PHC][Production Hobby Cluster] an excellent environment for developing and testing cloud-native microservices like [txToken]. While using Minikube or similar environments for testing and developing cloud-native [microservice]s, I find it a much better experience to use a more true-to-production cluster like [PHC][Production Hobby Cluster].

If in a few days you find yourself setting up a [Production Hobby Cluster] in Japan or Germany on [Linode], and another two in Australia and France on [vultr], then you may have just joined the PHC (Performance [Hobby Cluster]s) club. Some people tinker late at night on their truck, we benchmark and test the resilience of node failures on our overseas, budget kubernetes clusters. It's all about going big, on the cheap.

[![k8s performance hobby clusters](https://github.com/cjimti/mk/raw/master/images/content/k8s-tshirt-banner.jpg)](https://amzn.to/2IOe8Yu)

[Annotations]: https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md
[CORS]: https://en.wikipedia.org/wiki/Cross-origin_resource_sharing
[nginx]: http://nginx.org/en/docs/beginners_guide.html
[microservice]: http://microservices.io/
[Kubernetes]: https://kubernetes.io/
[txToken]: https://github.com/txn2/txtoken
[phc.txn2.net]: http://localhost:4000/tag/phc.txn2.net/
[Ingress]: /web-cluster-ingress/
[Production Hobby Cluster]: /hobby-cluster/
[Hobby Cluster]: /hobby-cluster/
[Linode]: https://www.linode.com/?r=848a6b0b21dc8edd33124f05ec8f99207ccddfde
[vultr]: https://www.vultr.com/?ref=7418713

