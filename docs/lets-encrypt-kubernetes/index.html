<!DOCTYPE html>
<html lang="en-us">
<head><head>
    <meta name="msvalidate.01" content="DBC34551F2DD1BA3DC0D62EE46D7448F" />
    <meta name="google-site-verification" content="DrtKc88u9uc7iptd4LyURAKBmFcOn7Kuk6HcRk_kNmo" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Automated, secure and free 443/https with signed x509 certificates for Ingress.">
    
    <meta name="keyword"  content="Go, Kubernetes, Elasticsearch, Python, Docker, Big Data, Artificial Intelligence, Machine Learning, Blockchain">
    <link rel="shortcut icon" href="https://imti.co/img/favicon.ico">

    <title>Let&#39;s Encrypt, Kubernetes - IMTI - Craig Johnston</title>

    <link rel="canonical" href="https://imti.co/lets-encrypt-kubernetes/">
	
    
    <link rel="stylesheet" href="https://imti.co/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="https://imti.co/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="https://imti.co/css/syntax.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <link rel="stylesheet" href="/css/imti.css">

    
    <script src="https://imti.co/js/jquery.min.js"></script>
    
    
    <script src="https://imti.co/js/bootstrap.min.js"></script>
    
    
    <script src="https://imti.co/js/hux-blog.min.js"></script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-5984764595236029",
            enable_page_level_ads: true
        });
    </script>

    <meta name="twitter:site" content="@cjimti">
<meta name="twitter:creator" content="@cjimti">

<meta name="twitter:description" content="Automated, secure and free 443/https with signed x509 certificates for Ingress." />
<meta name="twitter:title" content="Let&#39;s Encrypt, Kubernetes" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://imti.co/img/post/seal_876_438.jpg" />
<meta property="og:image" content="https://imti.co/img/post/seal_876_438.jpg" />



    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/imti.co\/lets-encrypt-kubernetes\/"
  },
  "headline": "Let\u0027s Encrypt, Kubernetes",
  "image": [
    "https:\/\/imti.co\/img\/post\/seal_876_438.jpg"
   ],
  "datePublished": "2018-05-18T00:00:00",
  "dateModified": "2018-05-18T00:00:00",
  "author": {
    "@type": "Person",
    "name": "Craig Johnston"
  },
   "publisher": {
    "@type": "Organization",
    "name": 'imti.co",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/imti.co\/img\/craig_johnston_cjimti.jpg"
    }
  },
  "description": "Use cert-manager to get port 443\/https running with signed x509 certificates for Ingress on your Kubernetes Production Hobby Cluster. cert-manager is the successor to kube-lego and the preferred way to \u0026ldquo;automatically obtain browser-trusted certificates, without any human intervention.\u0026rdquo; using Let\u0026rsquo;s Encrypt.\nYou need to install Helm first if you do not already have it. Otherwise, check out my article Helm on Custom Kubernetes, especially if you are following along with my Production Hobby Cluster guides."
}
</script>

</head></head>

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://imti.co/">IMTI</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="https://imti.co/">Home</a>
                    </li>
                    <li>
                        <a href="https://imti.co/about/">About</a>
                    </li>
                    <li>
                        <a href="https://twitter.com/cjimti">Follow</a>
                    </li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header{
        background-image: url('https://imti.co/img/post/seal.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/kubernetes" title="Kubernetes">
                        Kubernetes
                        </a>
                        
                        <a class="tag" href="/tags/security" title="Security">
                        Security
                        </a>
                        
                        <a class="tag" href="/tags/ingress" title="Ingress">
                        Ingress
                        </a>
                        
                    </div>
                    <h1>Let&#39;s Encrypt, Kubernetes</h1>
                    <h2 class="subheading">Automated, secure and free 443/https with signed x509 certificates for Ingress.</h2>
                    <span  class="meta">Posted by <a href="https://twitter.com/cjimti">Craig Johnston</a> on Friday, May 18, 2018
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>Use <a href="https://github.com/jetstack/cert-manager/">cert-manager</a> to get port 443/https running with signed x509 certificates for <a href="/web-cluster-ingress/">Ingress</a> on your Kubernetes <a href="/hobby-cluster/">Production Hobby Cluster</a>. <a href="https://github.com/jetstack/cert-manager/">cert-manager</a> is the successor to <strong>kube-lego</strong> and the preferred way to &ldquo;<a href="https://letsencrypt.org/how-it-works/">automatically obtain browser-trusted certificates, without any human intervention.</a>&rdquo; using <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>.</p>
<p>You need to <a href="/helm-on-custom-cluster/">install Helm</a> first if you do not already have it. Otherwise, check out my article <a href="/helm-on-custom-cluster/">Helm on Custom Kubernetes</a>, especially if you are following along with my <a href="/hobby-cluster/">Production Hobby Cluster</a> guides.</p>
<div class="ad-div">
    <a href="https://amzn.to/3hAZUvx">
        <img src="/img/kubernetes_platform_development.jpg" style="padding:0; margin: 0; width: 50%; float: left"/>
    </a>

    <div style="padding-left: 15px; overflow:auto;">
        <a href="https://amzn.to/3hAZUvx">Support this blog! Buy my new book:
            <h4>Advanced Platform Development with Kubernetes</h4>
        </a>
        <h5>What You'll Learn</h5>
        <ul style="padding-bottom: 0; margin: 0">
            <li>Build data pipelines with <b>MQTT, NiFi, Logstash, MinIO, Hive, Presto, Kafka and Elasticsearch</b></li>
            <li>Leverage <b>Serverless</b> ETL with <b>OpenFaaS</b></li>
            <li>Explore <b>Blockchain</b> networking with <b>Ethereum</b></li>
            <li>Support a multi-tenant <b>Data Science</b> platform with <b>JupyterHub, MLflow and Seldon Core</b></li>
            <li>Build a <b>Multi-cloud</b>, <b>Hybrid cluster</b>, securely bridging <b>on-premise</b> and cloud-based Kubernetes nodes</li>
        </ul>
    </div>
</div>

<h3 id="install-cert-manager">Install <a href="https://github.com/jetstack/cert-manager/">cert-manager</a></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm install --name cert-manager --namespace kube-system stable/cert-manager
</code></pre></div><p>After <a href="https://helm.sh/">Helm</a> installs <a href="https://github.com/jetstack/cert-manager/">cert-manager</a> you end up with a <a href="https://kubernetes.io/docs/admin/service-accounts-admin/">ServiceAccount</a> <a href="https://kubernetes.io/docs/admin/authorization/rbac/#role-and-clusterrole">ClusterRole</a>, <a href="https://kubernetes.io/docs/admin/authorization/rbac/#rolebinding-and-clusterrolebinding">ClusterRoleBinding</a>, <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a> and a couple of <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">Pod</a>s named <strong>cert-manager-cert-manager</strong> in the <strong>kube-system</strong> <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a>. <a href="https://helm.sh/">Helm</a> additionaly installs three <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/">CustomResourceDefinition</a>s for <a href="https://github.com/jetstack/cert-manager/">cert-manager</a> (custom resources are not namespaced):</p>
<ul>
<li>certificates.certmanager.k8s.io</li>
<li>clusterissuers.certmanager.k8s.io</li>
<li>issuers.certmanager.k8s.io</li>
</ul>
<p>It&rsquo;s good to know what <a href="https://helm.sh/">Helm</a> installed for <a href="https://github.com/jetstack/cert-manager/">cert-manager</a> and these three <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/">CustomResourceDefinition</a>s represent the configurations we are creating in the next steps.</p>
<p><a href="https://github.com/jetstack/cert-manager/">cert-manager</a> uses ether an <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html">Issuer</a> or <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a> to represent a certificate authority. <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html">Issuer</a> is bound to a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> so for our <a href="/hobby-cluster/">Production Hobby Cluster</a> we will use a <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>.</p>
<p>We will setup a <strong>letsencrypt-staging</strong> and a <strong>letsencrypt-prod</strong> <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>.</p>
<h3 id="create-a-clusterissuer">Create a <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a></h3>
<p>First, we need to have a functional <a href="/web-cluster-ingress/">Ingress</a> on our Kubernetes cluster. If you have not done so, check out my article <a href="/web-cluster-ingress/">Ingress on Custom Kubernetes</a>.</p>
<p>Create a file called <code>10-cluster-issuer-letsencrypt-staging.yml</code> for the <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>, add the following configuration and change the email address to your own.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: certmanager.k8s.io/v1alpha1
<span style="color:#66d9ef">kind</span>: ClusterIssuer
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: letsencrypt-staging
  <span style="color:#66d9ef">namespace</span>: default
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">acme</span>:
    <span style="color:#75715e"># The ACME server URL</span>
    <span style="color:#66d9ef">server</span>: https://acme-staging.api.letsencrypt.org/directory
    <span style="color:#75715e"># Email address used for ACME registration</span>
    <span style="color:#66d9ef">email</span>: someone@example.com
    <span style="color:#75715e"># Name of a secret used to store the ACME account private key</span>
    <span style="color:#66d9ef">privateKeySecretRef</span>:
      <span style="color:#66d9ef">name</span>: letsencrypt-staging
    <span style="color:#75715e"># Enable the HTTP-01 challenge provider</span>
    <span style="color:#66d9ef">http01</span>: {}
</code></pre></div><p>Create the staging <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a> with <code>kubectl</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f 10-cluster-issuer-letsencrypt-staging.yml
</code></pre></div><p>Expect output similar to the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clusterissuer.certmanager.k8s.io <span style="color:#e6db74">&#34;letsencrypt-staging&#34;</span> created
</code></pre></div><p>Check the status of the new <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl describe ClusterIssuer
</code></pre></div><p>Under the status section you should get output similar to the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#66d9ef">Conditions</span>:
    <span style="color:#66d9ef">Last Transition Time</span>:  <span style="color:#e6db74">2018-05-18T08:05:09Z</span>
    <span style="color:#66d9ef">Message</span>:               The ACME account was registered with the ACME server
    <span style="color:#66d9ef">Reason</span>:                ACMEAccountRegistered
    <span style="color:#66d9ef">Status</span>:                True
    <span style="color:#66d9ef">Type</span>:                  Ready
</code></pre></div><p>Now we can create a production <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>, for use only after we test with our staging configuration; otherwise, we are likely to hit rate limits while testing.</p>
<p>The only essential difference between the staging and production <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a> is the <code>server:</code> URL.</p>
<ul>
<li><strong>Staging</strong>: <code>server: https://acme-staging.api.letsencrypt.org/directory</code></li>
<li><strong>Production</strong>: <code>server: https://acme-v01.api.letsencrypt.org/directory</code></li>
</ul>
<p>Create a production <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a> with the configuration below, make sure to change the email address to a valid account. The configured email address may receive messages from <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>.</p>
<p>Create a file called <code>20-cluster-issuer-letsencrypt-production.yml</code> for the <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>, add the following configuration and change the email address.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: certmanager.k8s.io/v1alpha1
<span style="color:#66d9ef">kind</span>: ClusterIssuer
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: letsencrypt-production
  <span style="color:#66d9ef">namespace</span>: default
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">acme</span>:
    <span style="color:#75715e"># The ACME server URL</span>
    <span style="color:#66d9ef">server</span>: https://acme-v01.api.letsencrypt.org/directory
    <span style="color:#75715e"># Email address used for ACME registration</span>
    <span style="color:#66d9ef">email</span>: someone@example.com
    <span style="color:#75715e"># Name of a secret used to store the ACME account private key</span>
    <span style="color:#66d9ef">privateKeySecretRef</span>:
      <span style="color:#66d9ef">name</span>: letsencrypt-production
    <span style="color:#75715e"># Enable the HTTP-01 challenge provider</span>
    <span style="color:#66d9ef">http01</span>: {}
</code></pre></div><p>Create the production <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a> with <code>kubectl</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f 20-cluster-issuer-letsencrypt-production.yml
</code></pre></div><p>Ensure both <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html">ClusterIssuer</a>s are present:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get ClusterIssuer
</code></pre></div><p>Output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">NAME                     AGE
letsencrypt-production   3m
letsencrypt-staging      5m
</code></pre></div><h3 id="obtain-a-certificate">Obtain a Certificate</h3>
<p>Create a file named <code>30-Cert-DOMAIN.yml</code>, replacing <strong>DOMAIN</strong> with your domain. Copy the below configuration and change all the example domain references to your own. This configuration generates a test certificate from <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>&rsquo;s staging environment.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: certmanager.k8s.io/v1alpha1
<span style="color:#66d9ef">kind</span>: Certificate
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: example-com
  <span style="color:#66d9ef">namespace</span>: default
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">secretName</span>: example-com-staging-tls
  <span style="color:#66d9ef">issuerRef</span>:
    <span style="color:#66d9ef">name</span>: letsencrypt-staging
    <span style="color:#66d9ef">kind</span>: ClusterIssuer
  <span style="color:#66d9ef">commonName</span>: example.com
  <span style="color:#66d9ef">dnsNames</span>:
  - www.example.com
  <span style="color:#66d9ef">acme</span>:
    <span style="color:#66d9ef">config</span>:
    - <span style="color:#66d9ef">http01</span>:
        <span style="color:#66d9ef">ingressClass</span>: nginx
      <span style="color:#66d9ef">domains</span>:
      - example.com
    - <span style="color:#66d9ef">http01</span>:
        <span style="color:#66d9ef">ingress</span>: my-ingress
      <span style="color:#66d9ef">domains</span>:
      - www.example.com
</code></pre></div><p>The two <code>http01</code> sections under <code>acme:</code> demonstrate using the http-01 challenge with and without an existing ingress. The http-01 challenge creates or uses an existing ingress to create a route for <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> to determine that you control the domain. If you do not yet have an <a href="/web-cluster-ingress/">ingress</a> configuration or have <a href="/web-cluster-ingress/">Ingress</a> setup yet, I suggest checking out my article <a href="/web-cluster-ingress/">Ingress on Custom Kubernetes</a>, which builds on the <a href="/hobby-cluster/">Production Hobby Cluster</a> guide.</p>
<p>Create the test <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> with <code>kubectl</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f 30-Cert-DOMAIN.yml<span style="color:#e6db74">`</span>
</code></pre></div><p>Once we create the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> object we can check the status can find any errors. Generating staging certs give us opportunities to fix any mistakes and run the request for a cert multiple times without running into rate limitations.</p>
<p>Check the status with the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl describe certificate example-com
</code></pre></div><p>Under <code>Conditions:</code> look for <strong>Certificate issued successfully</strong>. If the certificate issued successfully, you can view it in the <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a> defined in your configuration. In our example, the secret is named <code>example-com-staging-tls</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get secret example-com-staging-tls -o yaml
</code></pre></div><p>In my experience you should include the <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> environment in the <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a> name, this avoids confusion when you update the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> to production, you want to see the new <strong>production</strong> secret generated.</p>
<h3 id="production">Production</h3>
<p>Edit the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> configuration to point to the <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> production environment URL, <code>server: https://acme-v01.api.letsencrypt.org/directory</code>. Change the secret name to include the work <strong>production</strong> rather than <strong>staging</strong> and apply the updated configuration.</p>
<p>Apply the production changes to the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> configuration with <code>kubectl</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f 30-Cert-DOMAIN.yml<span style="color:#e6db74">`</span>
</code></pre></div><p>Once again, check the status:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl describe certificate example-com
</code></pre></div><p>If you get <strong>Certificate issued successfully</strong> then you are now ready to use the new <strong>example-com-production-tls</strong> secret (cert) assuming you named it after your real domain.</p>
<h3 id="using-the-new-cert-for-ingress">Using the new cert for <a href="/web-cluster-ingress/">Ingress</a></h3>
<p>Now comes the easiest part, using the new <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> signed x509 certificate. I&rsquo;ll stick with using the domains example.com and <a href="http://www.example.com">www.example.com</a> for purposes of illustration.</p>
<p>Sample <a href="/web-cluster-ingress/">Ingress</a> using example cert:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: extensions/v1beta1
<span style="color:#66d9ef">kind</span>: Ingress
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: example
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: example
    <span style="color:#66d9ef">system</span>: test
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">rules</span>:
  - <span style="color:#66d9ef">host</span>: example.com
    <span style="color:#66d9ef">http</span>:
      <span style="color:#66d9ef">paths</span>:
      - <span style="color:#66d9ef">backend</span>:
          <span style="color:#66d9ef">serviceName</span>: <span style="color:#e6db74">&#34;ok&#34;</span>
          <span style="color:#66d9ef">servicePort</span>: <span style="color:#ae81ff">5001</span>
        <span style="color:#66d9ef">path</span>: /
  <span style="color:#66d9ef">tls</span>:
  - <span style="color:#66d9ef">hosts</span>:
    - example.com
    - www.example.com
    <span style="color:#66d9ef">secretName</span>: example-com-production-tls
</code></pre></div><h3 id="real-life-example">Real Life Example</h3>
<p>The following is my <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> and <a href="/web-cluster-ingress/">Ingress</a> configuration for the domains <a href="https://phc.imti.co">phc.imti.co</a>, <a href="https://phc.txn2.com">phc.txn2.com</a> and <a href="https://phc.txn2.net">phc.txn2.net</a>. I&rsquo;ll refrain from publishing my actual TLS certificate <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a>. <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> produces a Multi-Domain (SAN) Certificate, and as you might have noticed imti.co is hanging out at the bottom of the list; A separate TLD like this works but should probably be a separate cert, if I were concerned with having a matching <a href="https://www.quora.com/What-does-the-CN-name-in-a-client-certificate-refer-to">common name</a>. However, the sub-domain phc.imti.co is destined for a redirect, so it&rsquo;s not necessary.</p>
<p>I created the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">Certificate</a> configuration with the file name <code>00-phc-cert.yml</code>. I set these certs up before I added <a href="/web-cluster-ingress/">Ingress</a> rules but after I first pointed the DNS to the cluster. <a href="https://github.com/jetstack/cert-manager/">cert-manager</a> uses the <strong>nginx</strong> <a href="/web-cluster-ingress/">Ingress</a> as specified under <code>http01:</code> <code>ingressClass:</code> to temporarily create routes for <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> to verify the ownership of the domain.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: certmanager.k8s.io/v1alpha1
<span style="color:#66d9ef">kind</span>: Certificate
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: phc
  <span style="color:#66d9ef">namespace</span>: default
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">secretName</span>: phc-production-tls
  <span style="color:#66d9ef">issuerRef</span>:
    <span style="color:#66d9ef">name</span>: letsencrypt-production
    <span style="color:#66d9ef">kind</span>: ClusterIssuer
  <span style="color:#66d9ef">commonName</span>: phc.txn2.net
  <span style="color:#66d9ef">dnsNames</span>:
  - phc.txn2.net
  - phc.txn2.com
  - phc.imti.co
  <span style="color:#66d9ef">acme</span>:
    <span style="color:#66d9ef">config</span>:
    - <span style="color:#66d9ef">http01</span>:
        <span style="color:#66d9ef">ingressClass</span>: nginx
      <span style="color:#66d9ef">domains</span>:
      - phc.txn2.net
      - phc.txn2.com
      - phc.imti.co
</code></pre></div><p>I named the <a href="/web-cluster-ingress/">Ingress</a> configuration <code>10-ingress.yml</code> and all the domains use a
in the TLS <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a> defined in <code>secretName: phc-production-tls</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: extensions/v1beta1
<span style="color:#66d9ef">kind</span>: Ingress
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: ok-phc
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: ok-phc
    <span style="color:#66d9ef">system</span>: test
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">rules</span>:
  - <span style="color:#66d9ef">host</span>: phc.imti.co
    <span style="color:#66d9ef">http</span>:
      <span style="color:#66d9ef">paths</span>:
      - <span style="color:#66d9ef">backend</span>:
          <span style="color:#66d9ef">serviceName</span>: <span style="color:#e6db74">&#34;ok&#34;</span>
          <span style="color:#66d9ef">servicePort</span>: <span style="color:#ae81ff">5001</span>
        <span style="color:#66d9ef">path</span>: /
  - <span style="color:#66d9ef">host</span>: phc.txn2.net
    <span style="color:#66d9ef">http</span>:
      <span style="color:#66d9ef">paths</span>:
      - <span style="color:#66d9ef">backend</span>:
          <span style="color:#66d9ef">serviceName</span>: <span style="color:#e6db74">&#34;ok&#34;</span>
          <span style="color:#66d9ef">servicePort</span>: <span style="color:#ae81ff">5001</span>
        <span style="color:#66d9ef">path</span>: /
  - <span style="color:#66d9ef">host</span>: phc.txn2.com
    <span style="color:#66d9ef">http</span>:
      <span style="color:#66d9ef">paths</span>:
      - <span style="color:#66d9ef">backend</span>:
          <span style="color:#66d9ef">serviceName</span>: <span style="color:#e6db74">&#34;ok&#34;</span>
          <span style="color:#66d9ef">servicePort</span>: <span style="color:#ae81ff">5001</span>
        <span style="color:#66d9ef">path</span>: /
  <span style="color:#66d9ef">tls</span>:
  - <span style="color:#66d9ef">hosts</span>:
    - phc.txn2.net
    - phc.txn2.com
    - phc.imti.co
    <span style="color:#66d9ef">secretName</span>: phc-production-tls
</code></pre></div><p>I could have easily created a seperate cert for imti.co and grouped it under a seperate <code>hosts:</code> section. However I&rsquo;ll probably be redirecting it in the future so it suits my need at the moment.</p>
<h2 id="port-forwarding--local-development">Port Forwarding / Local Development</h2>
<p>Check out <a href="https://github.com/txn2/kubefwd">kubefwd</a> for a simple command line utility that bulk forwards services of one or more namespaces to your local workstation.</p>
<hr>
<p>If in a few days you find yourself setting up a cluster in Japan or Germany on <a href="https://www.linode.com/?r=848a6b0b21dc8edd33124f05ec8f99207ccddfde">Linode</a>, and another two in Australia and France on <a href="https://www.vultr.com/?ref=7418713">vultr</a>, then you may have just joined the PHC (Performance <a href="/hobby-cluster/">Hobby Cluster</a>s) club. Some people tinker late at night on their truck, we benchmark and test the resilience of node failures on our overseas, budget kubernetes clusters. It&rsquo;s all about going big, on the cheap.</p>
<p><a href="https://amzn.to/2IOe8Yu"><img src="https://github.com/cjimti/mk/raw/master/images/content/k8s-tshirt-banner.jpg" alt="k8s performance hobby clusters"></a></p>


                <p>
                   This blog post, titled: "<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Let&#39;s Encrypt, Kubernetes: Automated, secure and free 443/https with signed x509 certificates for Ingress.</span>" by <a xmlns:cc="http://creativecommons.org/ns#" href="https://twitter.com/cjimti" property="cc:attributionName" rel="cc:attributionURL">Craig Johnston</a>, is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
                    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
                </p>

                <h5>SUPPORT</h5>
                <p>
                    Order my new Kubernetes book: <a href="https://amzn.to/34D56v6">Advanced Platform Development with Kubernetes: Enabling Data Management, the Internet of Things, Blockchain, and Machine Learning</a>
                </p>
                <script type="text/javascript">
                  amzn_assoc_tracking_id = "imti-20";
                  amzn_assoc_ad_mode = "manual";
                  amzn_assoc_ad_type = "smart";
                  amzn_assoc_marketplace = "amazon";
                  amzn_assoc_region = "US";
                  amzn_assoc_design = "enhanced_links";
                  amzn_assoc_asins = "1484256107";
                  amzn_assoc_placement = "adunit";
                  amzn_assoc_linkid = "14a9d8b8d1b0bd44e9256e0e0a948015";
                </script>
                <script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>

                
                <hr>
                <h5>SHARE</h5>
                <ul class="list-inline">
                    <li><div class="addthis_inline_share_toolbox"></div></li>
                </ul>

                <h5>FOLLOW</h5>
                <ul class="list-inline">
                    <li><div class="addthis_inline_follow_toolbox"></div></li>
                </ul>

            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/blockchain" title="blockchain">
                        blockchain
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/data" title="data">
                        data
                        </a>
                        
                        
                        
                        <a href="/tags/data-science" title="data-science">
                        data-science
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/development" title="development">
                        development
                        </a>
                        
                        
                        
                        <a href="/tags/devops" title="devops">
                        devops
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                        docker
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                        elasticsearch
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/golang" title="golang">
                        golang
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/ingress" title="ingress">
                        ingress
                        </a>
                        
                        
                        
                        <a href="/tags/iot" title="iot">
                        iot
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/kubectl" title="kubectl">
                        kubectl
                        </a>
                        
                        
                        
                        <a href="/tags/kubernetes" title="kubernetes">
                        kubernetes
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/microservices" title="microservices">
                        microservices
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/python" title="python">
                        python
                        </a>
                        
                        
                        
                        <a href="/tags/raspberry-pi" title="raspberry-pi">
                        raspberry-pi
                        </a>
                        
                        
                        
                        <a href="/tags/security" title="security">
                        security
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/utils" title="utils">
                        utils
                        </a>
                        
                        
                        
                        
                        
                        
                    </div>
                </section>

                
                <hr>
                <h5>RELATED</h5>
                <ul class="list-inline">
                    
                </ul>
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href="" rel="alternate" type="application/rss+xml" title="IMTI" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:cjimti@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a href="https://twitter.com/cjimti">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/cjimti">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/cjimti/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                </ul>

                
                
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b905a667cf4d77c"></script>



    
        
        
    





<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-78786435-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
</html>
