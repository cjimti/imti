<!DOCTYPE html>
<html lang="en-us">
<head><head>
    <meta name="msvalidate.01" content="DBC34551F2DD1BA3DC0D62EE46D7448F" />
    <meta name="google-site-verification" content="DrtKc88u9uc7iptd4LyURAKBmFcOn7Kuk6HcRk_kNmo" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    
    <script data-cfasync="false">
        (function() {
            var savedTheme = localStorage.getItem('theme');
            var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            var theme = savedTheme || (prefersDark ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Continuous Integration &amp; Deployment">
    
    <meta name="keyword"  content="Go, Kubernetes, Elasticsearch, Python, Docker, Big Data, Artificial Intelligence, Machine Learning">
    <link rel="shortcut icon" href="../img/favicon.ico">

    <title>A Microservices Workflow with Golang and Gitlab CI - IMTI - Craig Johnston</title>

    <link rel="canonical" href="https://imti.co/gitlabci-golang-microservices/">

    
    <link rel="stylesheet" href="../css/bootstrap.min.css">

    
    <link rel="stylesheet" href="../css/hux-blog.min.css">

    
    <link rel="stylesheet" href="../css/syntax.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <link rel="stylesheet" href="../css/imti.css">

    
    <script src="../js/jquery.min.js"></script>

    
    <script src="../js/bootstrap.min.js"></script>

    
    <script src="../js/hux-blog.min.js"></script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-5984764595236029",
            enable_page_level_ads: true
        });
    </script>

    <meta name="twitter:site" content="@cjimti">
<meta name="twitter:creator" content="@cjimti">

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="A Microservices Workflow with Golang and Gitlab CI" />
<meta name="twitter:description" content="Continuous Integration &amp; Deployment" />
<meta name="twitter:image" content="https://imti.co/img/post/tracks_876_438.jpg" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://imti.co/gitlabci-golang-microservices/" />
<meta property="og:title" content="A Microservices Workflow with Golang and Gitlab CI" />
<meta property="og:description" content="Continuous Integration &amp; Deployment" />
<meta property="og:image" content="https://imti.co/img/post/tracks_876_438.jpg" />


    

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/imti.co\/gitlabci-golang-microservices\/"
  },
  "headline": "A Microservices Workflow with Golang and Gitlab CI",
  "image": ["https:\/\/imti.co\/img\/post\/tracks_876_438.jpg"],
  "datePublished": "2018-06-22T00:00:00Z",
  "dateModified": "2018-06-22T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Craig Johnston",
    "url": "https://imti.co/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "imti.co",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/imti.co\/img\/avatar-cj.jpg"
    }
  },
  "description": "Many of the resources on Cloud Native Microservices show you how easy it is to get up and running with AWS or GKE. I think this is great but for the fact that I â€¦"
}
</script>


</head>
</head>

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../">IMTI</a>
        </div>

        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="../">Home</a>
                    </li>
                    <li>
                        <a href="../about/">About</a>
                    </li>
                    <li>
                        <a href="https://twitter.com/cjimti">Follow</a>
                    </li>
                    

                    
                    <li>
                        <a href="javascript:void(0)" class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark/light mode">
                            <i class="fa fa-moon-o" id="theme-icon"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
            $navbar.className = " ";
            setTimeout(function(){
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header{
        background-image: url('https://imti.co/img/post/tracks.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="../tags/microservices" title="Microservices">
                        Microservices
                        </a>
                        
                        <a class="tag" href="../tags/devops" title="DevOps">
                        DevOps
                        </a>
                        
                        <a class="tag" href="../tags/golang" title="Golang">
                        Golang
                        </a>
                        
                        <a class="tag" href="../tags/gitlab" title="Gitlab">
                        Gitlab
                        </a>
                        
                    </div>
                    <h1>A Microservices Workflow with Golang and Gitlab CI</h1>
                    <h2 class="subheading">Continuous Integration &amp; Deployment</h2>
                    <span  class="meta">Posted by <a href="https://twitter.com/cjimti">Craig Johnston</a> on Friday, June 22, 2018
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>Many of the resources on Cloud Native <a href="../microservices/">Microservices</a> show you how easy it is to get up and running with AWS or GKE. I think this is great but for the fact that I see a trend (in my clients at least) of associating concepts with particular products or worse, companies. I love Amazon, but it&rsquo;s not THE cloud). In my opinion, to embrace Cloud Native and <a href="../microservices/">Microservices</a> you should develop some, and host them yourself. The cloud is not Google or Amazon; it&rsquo;s any cluster of virtualized systems, abstracted from their hardware interfaces and centrally managed.</p>


<p>The following workflow currently manages dozens of projects for me, some of which have been through thousands of builds; I find it highly stable. This workflow is also much more flexible and customizable than a lot of turn-key solutions. It requires a bit of explanation but typically only involves about twenty minutes of setup per microservice application, well worth the investment considering you get a simplified build and deploy script.</p>
<p><img src="../images/content/microservices-woirkflow.png" alt="Gitlab Microservices Workflow"></p>
<aside class="toc">
    <header>
        <h2>Contents</h2>
    </header>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#a-microservice-stack">A Microservice Stack</a></li>
    <li><a href="#the-microservice-application">The Microservice Application</a>
      <ul>
        <li><a href="#workflow--boilerplate">Workflow &amp; Boilerplate</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#port-forwarding--local-development">Port Forwarding / Local Development</a></li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
</aside>


<h2 id="overview">Overview</h2>
<p>If you are like me your early days were developing Java or Perl scripts that were installed on dev, staging or production hardware and executed under the Apache or Tomcat web servers, and that may still be part of your architecture today. Big monolithic applications, running on big fast servers that you could visit at the data center. However many developers like myself have started moving new development to Cloud Native <a href="../microservices/">Microservices</a>. The process of deploying monoliths is not really any different, except that while traditional monoliths do not tend to run in containers, they can.</p>
<p>Many tutorials I run across assume you might get to live in a utopian world, where all your code is open source and hosted on public <a href="https://github.com/">Github</a> repositories and deployment means up and running a local, single node <a href="../tag/Kubernetes/">k8s</a> cluster like Minikube. To be fair, this simplifies the technical details of the examples, and it broadens the audience by giving local sandbox examples that you can adapt to your production environment,  and helps many of us quickly get our head around novel concepts. This tutorial is intended to be applied directly to a production development process.</p>
<h2 id="a-microservice-stack">A Microservice Stack</h2>
<p>I choose five technologies in my workflow to give you some examples. I am referring to open source (and free) software only, not services.</p>
<ul>
<li>
<p><strong>Kubernetes with <a href="https://alpinelinux.org/">Alpine Linux</a> Docker</strong> containers is the core of my cloud. This cloud can be run almost anywhere from AWS to <a href="https://www.vultr.com/?ref=7418713">Vultr</a>, <a href="https://m.do.co/c/97b733e7eba4">Digital Ocean</a>, <a href="https://www.linode.com/?r=848a6b0b21dc8edd33124f05ec8f99207ccddfde">Linode</a> or some co-located servers you have running in a data center. If you want to learn how to set up a production style Kubernetes cluster on the cheap, I suggest reading my post, <a href="../hobby-cluster/">Production Hobby Cluster</a>. The <a href="../hobby-cluster/">Production Hobby Cluster</a> tutorial gets you a legit, highly available, three node Kubernetes cluster for about $15 a month. Don&rsquo;t plan on hosting Netflix on it, but when you need to scale your architecture it won&rsquo;t require a complete overhaul. Larger instances and more of them is often all that is needed to scale the <a href="../hobby-cluster/">Production Hobby Cluster</a> from hobby to enterprise.</p>
</li>
<li>
<p><strong><a href="https://golang.org/">Golang</a></strong> / <a href="https://golang.org/">Go</a> to write your <a href="../microservices/">Microservices</a>, those small API endpoints that satisfy some simple, single or small group of requirements. I use <a href="https://golang.org/">Go</a> because it compiles to a self-sufficient little binary that runs at home in the <a href="https://medium.com/@kelseyhightower/optimizing-docker-images-for-static-binaries-b5696e26eb07">smallest of Docker containers</a> and is able to efficiently serve raw TCP or HTTP traffic on a specified port. Go is also an excellent language for <a href="https://medium.com/@trstringer/create-Kubernetes-controllers-for-core-and-custom-resources-62fc35ad64a3">extending the cloud itself</a>, but that is a bit much for this article.</p>
</li>
<li>
<p><strong><a href="https://about.gitlab.com/installation/">Gitlab</a></strong> is my choice for self-hosted code and CI/CD (Automation). Github is fantastic and any code I do not need to keep private goes straight there; however, even my open source projects get cloned into Gitlab so I can take advantage of its simple build and deployment automation. I run <a href="https://docs.gitlab.com/ee/install/Kubernetes/index.html">a private copy of Gitlab in my cloud</a>. Some of my older projects run through Jenkins, and it&rsquo;s an excellent tool but overkill these days for most of my workflow, now that <a href="https://about.gitlab.com/installation/">Gitlab</a> has matured. Rather than pay for services I would rather pay for instances to grow my cluster and self-host more services.</p>
</li>
</ul>
<h2 id="the-microservice-application">The Microservice Application</h2>
<p>The following is a simplified workflow for a <a href="../microservices/">Microservices</a> application and one or more libraries as separate repositories. Not every lib needs its own. However, it&rsquo;s a good idea to separate any libraries that many projects share. Examples would be common <a href="https://tour.golang.org/moretypes/2">structs</a> or system-wide service implementations.</p>
<ul>
<li><strong>The Microservice application</strong>: <code>/go/src/gitlab.example.com/proj/app</code></li>
<li><strong>A library</strong>: <code>/go/src/gitlab.example.com/lib/example</code></li>
</ul>
<h3 id="workflow--boilerplate">Workflow &amp; Boilerplate</h3>
<p><a href="https://golang.org/">Golang</a> with <a href="https://about.gitlab.com/installation/">Gitlab</a> and <a href="https://Kubernetes.io/">Kubernetes</a>, Microservice application, file structure boilerplate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>README.md
</span></span><span style="display:flex;"><span>main.go
</span></span><span style="display:flex;"><span>Dockerfile
</span></span><span style="display:flex;"><span>./k8s/dev
</span></span><span style="display:flex;"><span>    10-namespace.yml
</span></span><span style="display:flex;"><span>    20-service.yml
</span></span><span style="display:flex;"><span>    30-config.yml
</span></span><span style="display:flex;"><span>    40-deployment.yml
</span></span><span style="display:flex;"><span>    50-ingress.yml
</span></span><span style="display:flex;"><span>    README.md
</span></span><span style="display:flex;"><span>.gitlab-ci.yml
</span></span></code></pre></div><p>I&rsquo;ll start at the top of the list and work down. Every repository needs a <strong>README.md</strong> with simple instruction for development and deployment, environment variables and build considerations. I opt for brief and straightforward documentation; I want my documentation as maintainable as my code. <a href="../microservices/">Microservices</a> should have micro-documentation, everything you need and not more.</p>
<h5 id="source-maingo-servergo">Source: <code>main.go</code> (<code>server.go</code>)</h5>
<p>Most of my <a href="../microservices/">Microservices</a> development start with something similar to this <a href="https://github.com/txn2/boilerplate-go/blob/master/server.go">server.go</a> boilerplate, using fast and simple <a href="https://gin-gonic.github.io/gin/">gin-gonic</a> for web/api framework and Uber&rsquo;s <a href="https://github.com/uber-go/zap">zap</a> for &ldquo;Blazing fast, structured, leveled logging&rdquo;.</p>
<p>What you don&rsquo;t see in the boilerplate are a few private libs that get added in depending on the project or specific service. These system-wide libs share business logic and import from the private Gitlab repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;private-gitlab.example.com/some/lib&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;private-gitlab.example.com/some/otherlib&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>It can be tricky allowing external build systems to pull these private libraries; however, that is overcome easily with Gitlab tokens and some updates to the <code>Dockerfile</code> and <code>.gitlab-ci.yml</code>.</p>
<h5 id="container-dockerfile">Container: <code>Dockerfile</code></h5>
<p>Nearly all my <a href="../microservices/">Microservices</a> use the same <code>Dockerfile</code>. There are some adjustments and variations, but most of the time this boilerplate gives me exactly what I need, a compiled binary in a super small Alpine Linux container.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">golang:1.10.2-alpine3.7</span> <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> GITLAB_TOKEN<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> GITLAB_DOMAIN<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> apk update <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span> <span style="color:#f92672">&amp;&amp;</span> apk add git<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> mkdir -p /go/src <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span> <span style="color:#f92672">&amp;&amp;</span> mkdir -p /go/bin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span> <span style="color:#f92672">&amp;&amp;</span> mkdir -p /go/pkg<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ENV</span> GOPATH<span style="color:#f92672">=</span>/go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ENV</span> PATH<span style="color:#f92672">=</span>$GOPATH/bin:$PATH<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> mkdir -p $GOPATH/src/app<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ADD</span> . $GOPATH/src/app<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ADD</span> . /go/src<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">$GOPATH/src/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># go get uses git to pull lib dependencies</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> git config --global url.<span style="color:#e6db74">&#34;https://oauth2:</span>$GITLAB_TOKEN<span style="color:#e6db74">@</span>$GITLAB_DOMAIN<span style="color:#e6db74">&#34;</span>.insteadOf <span style="color:#e6db74">&#34;https://</span>$GITLAB_DOMAIN<span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> go get .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> go get github.com/json-iterator/go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> go build -tags<span style="color:#f92672">=</span>jsoniter -a -installsuffix cgo -o /go/bin/server .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">alpine:3.7</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>WORKDIR /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /go/bin/server /server<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/server&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><strong>Grab a copy with wget if you like:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://gist.githubusercontent.com/cjimti/c988db3ff1a798eb3e18d76f3d71e75a/raw/adfaadc34c643f1af2c6ddfdc91aba80d6322fb7/Dockerfile
</span></span></code></pre></div><p>If your service needs to communicate out over https, you need to add <code>RUN apk add --no-cache ca-certificates</code> to install root certificates. However, I like to keep my containers as small as possible 5-15 megabyte range, so I only add what I need for the service. I could get these even smaller using <a href="https://medium.com/@kelseyhightower/optimizing-docker-images-for-static-binaries-b5696e26eb07"><code>scratch</code></a>, but I find <strong>Alpine Linux</strong> a good balance.</p>
<p>An important feature of this Dockerfile is allowing <code>go</code> to <code>go get</code> libraries from the private Gitlab repository.  The two <code>ARG</code> lines, <code>GITLAB_TOKEN</code> and <code>GITLAB_DOMAIN</code> are populated in <a href="https://docs.docker.com/engine/reference/commandline/build/">docker build</a> command found <code>.gitlab-ci.yml</code> that I go over further down this article. The git configuration directive <code>RUN git config --global url.&quot;https://oauth2:$GITLAB_TOKEN@$GITLAB_DOMAIN&quot;.insteadOf &quot;https://$GITLAB_DOMAIN&quot;</code> tells git to prepend <code>oauth2:$GITLAB_TOKEN</code> when pulling from <code>$GITLAB_DOMAIN</code>. Since our <code>$GITLAB_DOMAIN</code> is a private repository we need to use a token to authenticate from within the Docker container during the build process.</p>
<p>I generate a Gitlab token from a generic user that has access to all the repositories containing my privately shared libraries.</p>
<p>To test this container locally, you can run the <a href="https://docs.docker.com/engine/reference/commandline/build/">docker build</a> command found in <code>.gitlab-ci.yml</code> below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build --build-arg GITLAB_TOKEN<span style="color:#f92672">=</span>$GITLAB_TOKEN <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--build-arg GITLAB_DOMAIN<span style="color:#f92672">=</span>$GITLAB_DOMAIN <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>-t example_app .
</span></span></code></pre></div><p>First, you need to obtain a token from Gitlab, see below.</p>
<h5 id="gitlab-user-token"><a href="https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html">Gitlab User Token</a></h5>
<p>You need to create a <a href="https://about.gitlab.com/installation/">Gitlab</a> user with access to specific repositories, groups, or all (or use your personal account if you work solo). If your team is small, you may not need fine-grained security here. Remember we only need read-only access, so it&rsquo;s not essential to keep the secret safe from anyone who already had read access. Make sure to copy the generated token to your notes for use further down to configure the Gitlab project.</p>
<p><img src="../images/content/gitlab_access_tokens.png" alt="Gitlab Access Tokens"></p>
<p>All you need is the generated token; the <strong>Name</strong> is used for keeping track of your tokens in <strong>Gitlab</strong>.</p>
<h4 id="gitlab-project-settings-secret-variables">Gitlab Project Settings: Secret Variables</h4>
<p>Assuming you have already setup a Gitlab repository for your Microservice, add the <strong>Secret variables</strong> <code>GITLAB_DOMAIN</code> (should be something like gitlab.example.com), review its use in the <code>Dockerfile</code> above, and GITLAB_TOKEN, the one we just generated. GITLAB_TOKEN allows <code>go get</code> to pull private libraries in from your imports.</p>
<p>There are ways to avoid having to <code>go get</code> dependencies, by using utilities like <code>godeps</code> and pre-packaging required libraries; you don&rsquo;t have to retrieve at build time. However, this can also make development difficult if you are actively developing those libraries at the same time, as I often do. The configuration above gives you the option to do it either way.</p>
<p><img src="../images/content/gitlab_ci_cd_settings.png" alt="Gitlab Project Settings"></p>
<h4 id="kubernetes-k8sdev">Kubernetes: <code>./k8s/dev</code></h4>
<p>My workflow starts with deploying a minimally working version of my microservice to a development environment; this can be a separate cluster, a just a separate <a href="https://Kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a>. I use a separate cluster. Setting up a cheap development cluster is easy and gives you more opportunities to experiment; check out <a href="../hobby-cluster/">Production Hobby Cluster</a> for an agile environment perfect for development and experimentation.</p>
<p>We use <a href="https://Kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> to configure and deploy the new service. I&rsquo;ll assume you have some familiarity with it. <a href="https://Kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> makes it easy to switch between multiple clusters: <code>kubectl config use-context phc-dev</code>, see my post, <a href="../kubectl-remote-context/">kubectl Context Multiple Clusters</a> for a detailed example.</p>
<h5 id="namespace-k8sdev10-namespaceyml">Namespace: <code>./k8s/dev/10-namespace.yml</code></h5>
<p>I use a pretty standard form for all my Kubernetes objects. This example assumes we have a project called <code>the-project</code> and consists of many <a href="../microservices/">Microservices</a>. Although the <a href="https://Kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> is at the project level and not specific to a service, I keep a copy in each service. Duplicating this namespace configuration helps document the service and Kubernetes does not add the namespace if it already exists.</p>
<p>I also label every configuration with a <strong>client</strong> and <strong>env</strong>, this aids in selection rules and adds additional clarity of purpose.</p>
<p><strong>./k8s/dev/10-namespace.yml</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client</span>: <span style="color:#ae81ff">internal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#ae81ff">dev</span>
</span></span></code></pre></div><h5 id="service-k8sdev20-serviceyml">Service: <code>./k8s/dev/20-service.yml</code></h5>
<p><a href="https://Kubernetes.io/docs/concepts/services-networking/service/">Services</a> are persistent in Kubernetes. While <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a> come and go, <a href="https://Kubernetes.io/docs/concepts/services-networking/service/">Services</a> stick around and attach themselves to any <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a> that match their selection rules. I like to setup services first to help illustrate this decoupled nature.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client</span>: <span style="color:#ae81ff">internal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#e6db74">&#34;TCP&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span></code></pre></div><p>Most of my services attach to <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a> with the same name as the service. The <strong>name:</strong> of my Kubernetes object and <strong>app:</strong> labels nearly always match. I never prefix or suffix the object type as I have seen in some tutorials, this makes <a href="https://Kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> commands cleaner. Here are some examples of selecting all objects associated with a Microservice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get all -l app<span style="color:#f92672">=</span>example-microservice -n the-project
</span></span></code></pre></div><p>I use <strong>ClusterIP</strong> for <strong>type:</strong> because I don&rsquo;t need a publicly accessible IP address or port. I use <a href="../web-cluster-ingress/">Ingress on Custom Kubernetes</a> for external access.</p>
<h5 id="config-k8sdev30-configyml">Config: <code>./k8s/dev/30-config.yml</code></h5>
<p>Configuration using <strong>30-config.yml</strong> is optional since many of my <a href="../microservices/">Microservices</a> share the same configuration. However, the setup is the same.</p>
<p><strong>Example <code>./k8s/dev/30-config.yml</code></strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client</span>: <span style="color:#ae81ff">internal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dev_config.yml</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    something:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      important: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    token:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      encKey: &#34;somethingsecure&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      expHours: 24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cassandra:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster: [&#34;lax1.cas.example.com&#34;,&#34;ny1.cas.example.com&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      keyspace: dev_app</span>
</span></span></code></pre></div><p>In the deployment configuration below we mount this <a href="https://Kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> into the file system of our <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pod</a>. Mounting a <a href="https://Kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> as files allow our service to test outside the cloud with plain configuration files easily.</p>
<h5 id="deployment-k8sdev40-deploymentyml">Deployment: <code>./k8s/dev/40-deployment.yml</code></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: example-microservice
</span></span><span style="display:flex;"><span>  namespace: fuse
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: example-microservice
</span></span><span style="display:flex;"><span>    client: internal
</span></span><span style="display:flex;"><span>    env: dev
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: example-microservice
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: example-microservice
</span></span><span style="display:flex;"><span>        client: internal
</span></span><span style="display:flex;"><span>        env: dev
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      imagePullSecrets:
</span></span><span style="display:flex;"><span>        - name: example-microservice-regcred <span style="color:#75715e"># see k8s/README.md</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>        - name: config-volume
</span></span><span style="display:flex;"><span>          configMap:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># ConfigMap specified in 30-config.yml</span>
</span></span><span style="display:flex;"><span>            name: example-microservice
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>        - name: api5-auth
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># subsequent releases will use gitlab dev-PIPELINE_ID</span>
</span></span><span style="display:flex;"><span>          image: private-registry.example.com:5050/the-project/example-microservice:dev-latest
</span></span><span style="display:flex;"><span>          imagePullPolicy: Always
</span></span><span style="display:flex;"><span>          volumeMounts:
</span></span><span style="display:flex;"><span>          - name: config-volume
</span></span><span style="display:flex;"><span>            mountPath: /configs
</span></span><span style="display:flex;"><span>          env:
</span></span><span style="display:flex;"><span>            - name: BASE_PATH
</span></span><span style="display:flex;"><span>              value: <span style="color:#e6db74">&#34;/example/api/endpoint&#34;</span>
</span></span><span style="display:flex;"><span>            - name: CONFIG
</span></span><span style="display:flex;"><span>              value: <span style="color:#e6db74">&#34;/configs/dev_config.yml&#34;</span>
</span></span><span style="display:flex;"><span>            - name: DEBUG
</span></span><span style="display:flex;"><span>              value: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>            - name: PORT
</span></span><span style="display:flex;"><span>              value: <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>            - name: AGENT
</span></span><span style="display:flex;"><span>              valueFrom:
</span></span><span style="display:flex;"><span>                fieldRef:
</span></span><span style="display:flex;"><span>                  fieldPath: metadata.name
</span></span><span style="display:flex;"><span>          ports:
</span></span><span style="display:flex;"><span>            - name: tcp
</span></span><span style="display:flex;"><span>              containerPort: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><p>Before running you need another token from Gitlab: a Deploy Token Kubernetes needs to pull the image from Gitlab&rsquo;s repository.</p>
<h5 id="gitlab-project-settings-generate-gitlab-deploy-token">Gitlab Project Settings: Generate Gitlab Deploy Token</h5>
<p>In Gitlab under the repository settings for your <strong>example-microservice</strong>, choose <strong>Repository</strong> and expand the <strong>Deploy Tokens</strong> section. Create a deploy token by giving it a name (I leave the expiration empty) and check the <strong>read_registry</strong> scope. You need the generated <strong>Username</strong> and token below, keep them in your notes.</p>
<p><img src="../images/content/gitlab_deploy_token.png" alt="Gitlab Deploy Token"></p>
<p>In the <code>40-deployment.yml</code> file above you can review the entry under <strong>imagePullSecrets</strong> to see we reference <strong>example-microservice-regcred</strong>.</p>
<p>Create the <strong>example-microservice-regcred</strong> <a href="https://Kubernetes.io/docs/concepts/configuration/secret/">Secret</a> in Kubernetes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret docker-registry example-microservice-regcred <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --namespace<span style="color:#f92672">=</span>the-project <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --docker-server<span style="color:#f92672">=</span>private-registry.example.com:5050 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --docker-username<span style="color:#f92672">=</span>gitlab+deploy-token-8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --docker-password<span style="color:#f92672">=</span>GHKddKqY1gzW86yllh3x <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --docker-email<span style="color:#f92672">=</span>developer@example.com
</span></span></code></pre></div><p>The <code>kubectl create secret</code> command creates a special kind of <a href="https://Kubernetes.io/docs/concepts/configuration/secret/">Secret</a>, <a href="https://Kubernetes-v1-4.github.io/docs/user-guide/kubectl/kubectl_create_secret_docker-registry/">docker-registry</a> used by Kubernetes when issuing pulls for Docker containers. This secret is made available for all the <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/">deployments</a> in the <code>the-project</code> <a href="https://Kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a>. The <code>--docker-server</code> parameter specifies the repository host and port. In this case, we use the <a href="https://docs.gitlab.com/ee/user/project/container_registry.html">Gitlab container registry</a> of our private Gitlab installation. The <code>--docker-username</code> and <code>--docker-password</code> parameters were generated in the <code>kubectl create secret docker-registry</code> command above.</p>
<p>Once the secret is created it can be used by adding <code>example-microservice-regcred</code> in the <strong>imagePullSecrets</strong> for our <strong>example-microservice</strong> <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/">deployment</a>.</p>
<h5 id="ingress-k8sdev50-ingressyml">Ingress <code>./k8s/dev/50-ingress.yml</code></h5>
<p>Setup <a href="../web-cluster-ingress/">Ingress on Custom Kubernetes</a> if you have not done so already. You should also secure your <a href="../web-cluster-ingress/">ingress</a> API endpoints with HTTPS, a secure, free and easy way of doing this involves setting up <a href="../lets-encrypt-Kubernetes/">Let&rsquo;s Encrypt on Kubernetes</a> with <a href="https://github.com/jetstack/cert-manager/">cert-manager</a>.</p>
<p><strong>50-ingress.yml</strong></p>
<p>The following <a href="../web-cluster-ingress/">Ingress on Custom Kubernetes</a> configuration directs traffic for <strong>HTTP port 80</strong> and <strong>HTTPS port 443</strong> on our example domain <strong>api.the-project.dev.example.com</strong> to port 8080 on the <strong>example-microservice</strong> we setup in <a href="https://Kubernetes.io/docs/concepts/services-networking/service/">Services</a> configuration <a href="#service-k8sdev20-serviceyml"><code>20-service.yml</code> above</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client</span>: <span style="color:#ae81ff">internal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">api.the-project.dev.example.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">example-microservice</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/example/api/endpoint</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">api.example.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">the-project-dev-production-tls</span>
</span></span></code></pre></div><h4 id="initial-kubernetes-deployment">Initial Kubernetes Deployment</h4>
<p>I never automate the initial configuration and deployment of <a href="../microservices/">Microservices</a> in Kubernetes. There are a few things that once setup don&rsquo;t need to change per iteration. Packing the install for automatic configuration and deployment is better left to the Kubernetes package manager <a href="../helm-on-custom-cluster/">Helm</a>, and after development iterations have stabilized into a more mature state. In this example workflow we are just getting started.</p>
<p><strong>The quick way</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ./k8s/dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create -f .
</span></span></code></pre></div><p><strong>The sane way</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ./k8s/dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create -f ./10-namespace.yml
</span></span><span style="display:flex;"><span>kubectl create -f ./20-service.yml
</span></span><span style="display:flex;"><span>kubectl create -f ./30-config.yml
</span></span><span style="display:flex;"><span>kubectl create -f ./40-deployment.yml
</span></span><span style="display:flex;"><span>kubectl create -f ./50-ingress.yml
</span></span></code></pre></div><p>You should now have a couple of <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a>, a <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a>, a <a href="https://Kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a>, a <a href="https://Kubernetes.io/docs/concepts/services-networking/service/">Service</a> and <a href="../web-cluster-ingress/">Ingress</a> all labeled with <code>app: example-microservice</code> in the <a href="https://Kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> <code>the-project</code>.</p>
<p>List the Kubernetes objects:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get po,svc,deploy,ing -l app<span style="color:#f92672">=</span>example-microservice -n the-project
</span></span></code></pre></div><p>The deployment above fails, erroring on the fact that there is no container image to pull for the <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pod</a> we specified in the <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a>  (<code>40-deployment.yml</code>).  You can always build an image and push it to Gitlab&rsquo;s registry before configuring the deployment; however, Kubernetes continues attempts to pull the image. This error is ok and how I typically set up new projects. Since the CI scripts job is to build and deploy by updating an image, it&rsquo;s easier if there is already a <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a> waiting for it. This process might make more sense when we review the <code>.gitlab-ci.yml</code> CI script below.</p>
<h4 id="automated-builds-and-deployments-gitlab-ciyml">Automated Builds and Deployments: <code>.gitlab-ci.yml</code></h4>
<p>Make sure to first <a href="https://docs.gitlab.com/ee/ci/quick_start/#configuring-a-runner">configure runners</a> in Gitlab and <a href="https://docs.gitlab.com/ee/ci/runners/">enable runners for the current repository</a>. When you push source code into Gitlab, and CI is enabled. Gitlab executes the instructions found in <code>.gitlab-ci.yml</code> if one exists.</p>
<p>The following is an example <code>.gitlab-ci.yml</code> I commonly use for building and deploying <a href="../microservices/">Microservices</a> in Kubernetes. Skim over the file and after I&rsquo;ll go over the critical parts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">image</span>: <span style="color:#ae81ff">txn2/docker-kubectl</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">DOCKER_DRIVER</span>: <span style="color:#ae81ff">overlay2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">GIT_STRATEGY</span>: <span style="color:#ae81ff">fetch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} private-registry.example.com:5050</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dev_build</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">only</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">dev@the-project/example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker build -t ${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID} -f ./k8s/Dockerfile .</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push ${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID}</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker tag ${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID} ${CI_REGISTRY_IMAGE}:dev-latest</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push ${CI_REGISTRY_IMAGE}:dev-latest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># update the deployment image</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dev_deploy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">only</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">dev@the-project/example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">GIT_STRATEGY</span>: <span style="color:#ae81ff">none</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kubectl set image deployment/example-microservice cog=${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID} \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --namespace=&#34;the-project&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --server=&#34;${K8S_DEV_SERVER}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --token=&#34;${K8S_DEV_TOKEN}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --insecure-skip-tls-verify=true</span>
</span></span></code></pre></div><h5 id="runner-image-txn2docker-kubectl">Runner <code>image: txn2/docker-kubectl</code></h5>
<p>The build script uses Docker and <code>kubectl</code>. You can use any base image and install these as part of the build and deploy stages; however, I find it faster to use an image with these utilities already installed. Use the Docker container <a href="https://github.com/txn2/docker-kubectl">txn2/docker-kubectl</a> or create your own.</p>
<p><strong>Dockerfile</strong> for Gitlab Kubernetes deployments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">docker:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> apk update<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> apk add curl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> curl -LO https://storage.googleapis.com/Kubernetes-release/release/<span style="color:#66d9ef">$(</span>curl -s https://storage.googleapis.com/Kubernetes-release/release/stable.txt<span style="color:#66d9ef">)</span>/bin/linux/amd64/kubectl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> chmod u+x kubectl <span style="color:#f92672">&amp;&amp;</span> mv kubectl /bin/kubectl<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>If you choose to create a custom container, you need to make sure it is publicly accessible. <a href="https://github.com/txn2/docker-kubectl">Docker Hub</a> hosts public images free of charge. You are welcome to stick with <a href="https://github.com/txn2/docker-kubectl">txn2/docker-kubectl</a></p>
<h5 id="runner-before_script">Runner <code>before_script</code></h5>
<p>The runner needs access to push Docker containers it builds back to the <a href="https://docs.gitlab.com/ee/user/project/container_registry.html">Gitlab container registry</a>. <a href="https://docs.gitlab.com/ee/ci/variables/">GitLab CI/CD Variables</a> provides the <code>CI_JOB_TOKEN</code> specifically for registry authentication. We don&rsquo;t need Docker access for every stage. However, it&rsquo;s a minor operation to issue a <a href="https://docs.docker.com/engine/reference/commandline/login/">Docker login</a>, so it&rsquo;s one less thing we have to think about should we require access in later stages; for instance, a testing stage that may tag containers as passing or failing.</p>
<p><strong>Excerpt from <a href="../gitlabci-golang-microservices/#automated-builds-and-deployments-gitlab-ciyml">.gitlab-ci.yml</a></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} private-registry.example.com:5050</span>
</span></span></code></pre></div><h5 id="runner-dev_build">Runner <code>dev_build</code></h5>
<p>The <code>deb_build</code> might look a little complicated, but it is only the <a href="https://docs.docker.com/engine/reference/commandline/build/">docker build</a>, <a href="https://docs.docker.com/engine/reference/commandline/tag/">docker tag</a> and <a href="https://docs.docker.com/engine/reference/commandline/push/">docker push</a> commands along with the use of a few  <a href="https://docs.gitlab.com/ee/ci/variables/">GitLab CI/CD Variables</a>.</p>
<p>The <a href="https://docs.gitlab.com/ee/ci/variables/">GitLab CI/CD Variables</a> used:</p>
<ul>
<li><strong><code>CI_REGISTRY_IMAGE</code></strong> returns the address of the registry tied to the specific project.</li>
<li><strong><code>CI_PIPELINE_ID</code></strong> is the unique id of the current pipeline that GitLab CI uses internally. This variable gives us an always incrementing number, and this helps to distinguish our new container from a previously built one more easily. We could use a separate versioning system or even re-tag with an assigned version number after passing some test. The options are limitless.</li>
</ul>
<p><strong>Excerpt from <a href="../gitlabci-golang-microservices/#automated-builds-and-deployments-gitlab-ciyml">.gitlab-ci.yml</a></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">dev_build</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">only</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">dev@the-project/example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker build -t ${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID} -f ./k8s/Dockerfile .</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push ${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID}</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker tag ${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID} ${CI_REGISTRY_IMAGE}:dev-latest</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push ${CI_REGISTRY_IMAGE}:dev-latest</span>
</span></span></code></pre></div><p>The <code>dev_build:</code> section <strong>only:</strong> to ensure the <code>dev_build:</code> script is run when the <strong>dev</strong> branch of the main repository receives a merge (after a pull request is approved). The directive <code>dev@the-project/example-microservice</code> ensures it does not run on forks of this repository.</p>
<p>Tagging a container <code>dev</code> lets us know that this container is not yet ready for production, it may need testing or may contain features not yet approved for production deployment. Additional tags can easily be given to this image in later stages, or new containers can be generated specifically for production.</p>
<p>This workflow assumes four or more git branches. In the example <a href="../gitlabci-golang-microservices/#automated-builds-and-deployments-gitlab-ciyml">.gitlab-ci.yml</a> I only cover operations on the <strong>dev</strong> branch, but you can easily extrapolate how <strong>stg</strong> and <strong>prod</strong> branches might work.</p>
<table>
  <thead>
      <tr>
          <th>Branch</th>
          <th>Purpose</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>dev</strong></td>
          <td>The <strong>dev</strong> branch is anything in development, even features that may never be released. The code in the <strong>dev</strong> branch is continuously built and deployed to a development environment.</td>
      </tr>
      <tr>
          <td><strong>stg</strong></td>
          <td>The <strong>stg</strong> branch is for staging a service for the next production release, and any merges to the <strong>stg</strong> branch are built and deployed to the staging environment to await final approval for production release.</td>
      </tr>
      <tr>
          <td><strong>prod</strong></td>
          <td>The <strong>prod</strong> branch contains code reflecting the current state of production and any code pushed to the <strong>prod</strong> branch is release to the production environment.</td>
      </tr>
      <tr>
          <td><strong>master</strong></td>
          <td>The <strong>master</strong> branch is a reflection of the <strong>prod</strong> branch with no CI/CD triggers or jobs associated with it.</td>
      </tr>
  </tbody>
</table>
<h5 id="runner-dev_deploy">Runner <code>dev_deploy</code></h5>
<p>In this example the <strong>stage: deploy</strong> runs directly after <strong>stage: build</strong>. In a more sophisticated setup, we may want to run some tests before and after a development deployment.</p>
<p>The <strong><code>dev_deploy:</code></strong> script deploys our new container with one command: <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment">kubectl set image</a>. Setting a new image on a <a href="https://Kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a> triggers Kubernetes to pull the new image, spin up the defined number of required <a href="https://Kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a>, then shut down any pods running the previous image. <a href="https://Kubernetes.io/docs/tutorials/Kubernetes-basics/update/update-intro/">Rolling updates</a> are a powerful feature of Kubernetes and help prevent any downtime if handled correctly.</p>
<p><strong>Excerpt from <a href="../gitlabci-golang-microservices/#automated-builds-and-deployments-gitlab-ciyml">.gitlab-ci.yml</a></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># update the deployment image</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dev_deploy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">only</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">dev@the-project/example-microservice</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">GIT_STRATEGY</span>: <span style="color:#ae81ff">none</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kubectl set image deployment/example-microservice example-microservice=${CI_REGISTRY_IMAGE}:dev-${CI_PIPELINE_ID} \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --namespace=&#34;the-project&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --server=&#34;${K8S_DEV_SERVER}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --token=&#34;${K8S_DEV_TOKEN}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --insecure-skip-tls-verify=true</span>
</span></span></code></pre></div><p>Note the new variables <strong>K8S_DEV_SERVER</strong> and <strong>K8S_DEV_TOKEN</strong>.</p>
<table>
  <thead>
      <tr>
          <th>Parameter</th>
          <th>Purpose</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>--server=&quot;${K8S_DEV_SERVER}&quot;</code></td>
          <td>Tells <a href="https://Kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> what cluster to use.</td>
      </tr>
      <tr>
          <td><code>--token=&quot;${K8S_DEV_TOKEN}&quot;</code></td>
          <td>used for <a href="https://Kubernetes.io/docs/reference/access-authn-authz/authentication/">authentication</a>.</td>
      </tr>
  </tbody>
</table>
<p>If your <a href="../hobby-cluster/">custom Kubernetes cluster</a> uses Role-based access control (<a href="https://Kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC</a>), and it should, use the following steps to get a token granting <code>kubectl</code> access to <code>the-project</code> namespace.</p>
<p>You can combine three configuration directives into one yaml file and get the objects you need in Kubernetes. You need a <a href="https://Kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/">ServiceAccount</a>, a <a href="https://Kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings">Role</a> and a <a href="https://Kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings">RoleBinding</a> tying the two together.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;apps&#34;</span>,<span style="color:#e6db74">&#34;extensions&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;deployments&#34;</span>,<span style="color:#e6db74">&#34;configmaps&#34;</span>,<span style="color:#e6db74">&#34;pods&#34;</span>,<span style="color:#e6db74">&#34;secrets&#34;</span>,<span style="color:#e6db74">&#34;ingresses&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;create&#34;</span>,<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;delete&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>,<span style="color:#e6db74">&#34;update&#34;</span>,<span style="color:#e6db74">&#34;edit&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;exec&#34;</span>,<span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">the-project</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span> <span style="color:#75715e">#this must be Role or ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployer</span> <span style="color:#75715e"># this must match the name of the Role or ClusterRole you wish to bind to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><p>You need to extract the generated token from a <a href="https://Kubernetes.io/docs/concepts/configuration/secret/">secret</a> automatically created for the new <a href="https://Kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/">ServiceAccount</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl describe serviceaccount the-project -n fuse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:                the-project
</span></span><span style="display:flex;"><span>Namespace:           the-project
</span></span><span style="display:flex;"><span>Labels:              &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:         &lt;none&gt;
</span></span><span style="display:flex;"><span>Image pull secrets:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Mountable secrets:   the-project-token-bc7d2
</span></span><span style="display:flex;"><span>Tokens:              the-project-token-bc7d2
</span></span><span style="display:flex;"><span>Events:              &lt;none&gt;
</span></span></code></pre></div><p>The <strong>Tokens:</strong> key points to the name of the <a href="https://Kubernetes.io/docs/concepts/configuration/secret/">secret</a> holding the token we need:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl describe secret the-project-token-bc7d2 -n the-project
</span></span></code></pre></div><p>Under the <strong>token:</strong> key in the described <a href="https://Kubernetes.io/docs/concepts/configuration/secret/">secret</a>, cut and past this long password. The token is useful for any application needing to deploy into the-project <a href="https://Kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a>.</p>
<p>Next, paste the key into Gitlab along with the path to your Kubernetes cluster.</p>
<p><strong>Giltab Project</strong> &gt; <strong>Settings (gear)</strong> &gt; <strong>CI/CD</strong> &gt; <strong>Secret variables</strong>:</p>
<p><img src="../images/content/gitlab_secret_variables_2.png" alt="Gitlab secret variables"></p>
<p>These four variables allow Gitlab to communicate with its own registry from a container in the <strong>build stage</strong> with <code>GITLAB_DOMAIN</code> and <code>GITLAB_TOKEN</code>, and allow it to communicate with Kubernetes in the <strong>deploy stage</strong> with <code>K8S_DEV_SERVER</code> and <code>K8S_DEV_TOKEN</code>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The process above takes me about twenty minutes per microservice application to setup. Considering that these projects may be around for years, and go through hundreds or even thousands of builds makes this a minimal investment in time.</p>
<p>Streamlining this workflow can be accomplished with utilities like the Kubernetes package manager <a href="../helm-on-custom-cluster/">Helm</a>. However, caution is advised to ensure that every step in the workflow should make the workflow more clear and easy to visualize and understand a year from now. We should not be developing workflows for the sake of the workflow setup process. Build and deploy pipeline should make the process of using them and debugging them easy, years after they are up and running.</p>


<h2 id="port-forwarding--local-development">Port Forwarding / Local Development</h2>
<p>Check out <a href="https://github.com/txn2/kubefwd">kubefwd</a> for a simple command line utility that bulk forwards services of one or more namespaces to your local workstation.</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="../hobby-cluster/">Production Hobby Cluster</a></li>
<li><a href="../web-cluster-ingress/">Ingress on Custom Kubernetes</a></li>
<li><a href="../lets-encrypt-Kubernetes/">Let&rsquo;s Encrypt on Kubernetes</a></li>
<li><a href="https://medium.com/@trstringer/create-Kubernetes-controllers-for-core-and-custom-resources-62fc35ad64a3">Extending Kubernetes: Create Controllers for Core and Custom Resources</a></li>
<li>The package manager <a href="../helm-on-custom-cluster/">Helm on Custom Kubernetes</a></li>
</ul>


                <p>
                   This blog post, titled: "<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">A Microservices Workflow with Golang and Gitlab CI: Continuous Integration &amp; Deployment</span>" by <a xmlns:cc="http://creativecommons.org/ns#" href="https://twitter.com/cjimti" property="cc:attributionName" rel="cc:attributionURL">Craig Johnston</a>, is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
                    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
                </p>

            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="../tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="../tags/ai" title="ai">
                        ai
                        </a>
                        
                        
                        
                        <a href="../tags/blockchain" title="blockchain">
                        blockchain
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/data" title="data">
                        data
                        </a>
                        
                        
                        
                        <a href="../tags/data-science" title="data science">
                        data science
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/development" title="development">
                        development
                        </a>
                        
                        
                        
                        <a href="../tags/devops" title="devops">
                        devops
                        </a>
                        
                        
                        
                        
                        
                        <a href="../tags/docker" title="docker">
                        docker
                        </a>
                        
                        
                        
                        <a href="../tags/elasticsearch" title="elasticsearch">
                        elasticsearch
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/golang" title="golang">
                        golang
                        </a>
                        
                        
                        
                        
                        
                        <a href="../tags/ingress" title="ingress">
                        ingress
                        </a>
                        
                        
                        
                        <a href="../tags/iot" title="iot">
                        iot
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/kubectl" title="kubectl">
                        kubectl
                        </a>
                        
                        
                        
                        <a href="../tags/kubefwd" title="kubefwd">
                        kubefwd
                        </a>
                        
                        
                        
                        <a href="../tags/kubernetes" title="kubernetes">
                        kubernetes
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/mcp" title="mcp">
                        mcp
                        </a>
                        
                        
                        
                        
                        
                        <a href="../tags/microservices" title="microservices">
                        microservices
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/python" title="python">
                        python
                        </a>
                        
                        
                        
                        <a href="../tags/raspberry-pi" title="raspberry pi">
                        raspberry pi
                        </a>
                        
                        
                        
                        <a href="../tags/security" title="security">
                        security
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="../tags/utils" title="utils">
                        utils
                        </a>
                        
                        
                        
                        
                        
                        
                    </div>
                </section>

                
                <hr>
                <h5>RELATED</h5>
                <ul class="list-inline">
                    
                </ul>
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href="../index.xml" rel="alternate" type="application/rss+xml" title="IMTI" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:cjimti@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a href="https://twitter.com/cjimti">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/cjimti">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/cjimti/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                </ul>
            </div>
        </div>
    </div>
</footer>


<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<script>
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-R56SP4WLS2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R56SP4WLS2');
</script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({ theme: 'neutral' });
  mermaid.run();
</script>


<script data-cfasync="false">
(function() {
    var themeToggle = document.getElementById('theme-toggle');
    var themeIcon = document.getElementById('theme-icon');

    function getCurrentTheme() {
        return document.documentElement.getAttribute('data-theme') || 'light';
    }

    function updateIcon() {
        var currentTheme = getCurrentTheme();
        if (themeIcon) {
            if (currentTheme === 'dark') {
                themeIcon.className = 'fa fa-sun-o';
            } else {
                themeIcon.className = 'fa fa-moon-o';
            }
        }
    }

    function toggleTheme() {
        var currentTheme = getCurrentTheme();
        var newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        if (newTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.removeAttribute('data-theme');
        }

        localStorage.setItem('theme', newTheme);
        updateIcon();
    }

    updateIcon();

    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }

    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                updateIcon();
            }
        });
    }
})();
</script>

</body>
</html>
